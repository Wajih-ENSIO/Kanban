<script type="module">
    // 1. Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // 2. Your specific Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCLtVFMtBFYjKHqsKIk-RFDbEE9B3szs_Q",
        authDomain: "kanban-board-c7048.firebaseapp.com",
        projectId: "kanban-board-c7048",
        storageBucket: "kanban-board-c7048.firebasestorage.app",
        messagingSenderId: "834915286423",
        appId: "1:834915286423:web:043c8d49d0a60568f758d2"
    };

    // 3. Initialize Firebase & Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const boardDocRef = doc(db, "kanban", "shared-board");

    let tasks = [];
    let draggedTaskId = null;

    // --- REAL-TIME SYNC ---
    // This function watches the database. If anyone changes a task, 
    // it updates on everyone's screen immediately.
    function listenToTasks() {
        onSnapshot(boardDocRef, (doc) => {
            if (doc.exists()) {
                tasks = doc.data().tasks || [];
            } else {
                tasks = [];
            }
            renderTasks();
        });
    }

    // --- SAVE TO CLOUD ---
    async function saveTasks() {
        try {
            await setDoc(boardDocRef, { tasks: tasks });
        } catch (error) {
            console.error('Firebase Save Error:', error);
            alert("Erreur lors de l'enregistrement. VÃ©rifiez vos rÃ¨gles Firebase.");
        }
    }

    // --- UI FUNCTIONS ---
    window.openModal = function() {
        document.getElementById('modalTitle').textContent = 'Nouvelle tÃ¢che';
        document.getElementById('submitBtn').textContent = 'CrÃ©er';
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        document.getElementById('taskStatus').parentElement.style.display = 'none';
        document.getElementById('taskModal').classList.add('active');
    };

    window.closeModal = function() {
        document.getElementById('taskModal').classList.remove('active');
    };

    window.deleteTask = function(id) {
        if (confirm('Supprimer cette tÃ¢che ?')) {
            tasks = tasks.filter(t => t.id !== id);
            saveTasks();
        }
    };

    function openEditModal(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        document.getElementById('modalTitle').textContent = 'Modifier la tÃ¢che';
        document.getElementById('submitBtn').textContent = 'Enregistrer';
        document.getElementById('taskId').value = task.id;
        document.getElementById('taskTitle').value = task.title;
        document.getElementById('taskDescription').value = task.description;
        document.getElementById('taskAuthor').value = task.author;
        document.getElementById('taskStatus').value = task.status;
        document.getElementById('taskStatus').parentElement.style.display = 'block';
        document.getElementById('taskModal').classList.add('active');
    }

    // --- FORM SUBMISSION ---
    document.getElementById('taskForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const taskId = document.getElementById('taskId').value;
        
        if (taskId) {
            const task = tasks.find(t => t.id === parseInt(taskId));
            if (task) {
                task.title = document.getElementById('taskTitle').value;
                task.description = document.getElementById('taskDescription').value;
                task.author = document.getElementById('taskAuthor').value || 'Anonyme';
                task.status = document.getElementById('taskStatus').value;
            }
        } else {
            const task = {
                id: Date.now(),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                author: document.getElementById('taskAuthor').value || 'Anonyme',
                status: 'todo',
                createdAt: new Date().toLocaleDateString('fr-FR')
            };
            tasks.push(task);
        }
        saveTasks();
        closeModal();
    });

    // --- RENDERING ---
    function renderTasks() {
        document.querySelectorAll('.tasks-container').forEach(container => container.innerHTML = '');

        tasks.forEach(task => {
            const taskEl = document.createElement('div');
            taskEl.className = 'task';
            taskEl.draggable = true;
            taskEl.dataset.id = task.id;
            taskEl.innerHTML = `
                <div class="task-title">${task.title}</div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                <div class="task-meta">
                    <span>ğŸ‘¤ ${task.author} â€¢ ${task.createdAt}</span>
                    <button class="delete-btn" onclick="event.stopPropagation(); window.deleteTask(${task.id})">ğŸ—‘ï¸</button>
                </div>
            `;

            taskEl.addEventListener('click', (e) => {
                if (!e.target.classList.contains('delete-btn')) {
                    openEditModal(parseInt(taskEl.dataset.id));
                }
            });

            taskEl.addEventListener('dragstart', function() {
                draggedTaskId = parseInt(this.dataset.id);
                this.classList.add('dragging');
            });

            taskEl.addEventListener('dragend', function() {
                this.classList.remove('dragging');
            });

            const container = document.querySelector(`[data-status="${task.status}"] .tasks-container`);
            if (container) container.appendChild(taskEl);
        });
        setupDropZones();
    }

    function setupDropZones() {
        document.querySelectorAll('.tasks-container').forEach(container => {
            container.ondragover = (e) => e.preventDefault();
            container.ondrop = function(e) {
                e.preventDefault();
                if (draggedTaskId) {
                    const newStatus = this.parentElement.dataset.status;
                    const task = tasks.find(t => t.id === draggedTaskId);
                    if (task && task.status !== newStatus) {
                        task.status = newStatus;
                        saveTasks();
                    }
                }
            };
        });
    }

    // Initialize
    listenToTasks();
</script>
